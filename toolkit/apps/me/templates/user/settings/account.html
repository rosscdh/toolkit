{% extends 'gui.html' %}

{% load url from future %}{% load crispy_forms_tags %}

{% block page_title %}Settings â€” {{ block.super }}{% endblock%}

{% block sidebar %}
{% endblock %}

{% block header %}
    <h4>Account Setup</h4>
{% endblock %}

{% block body %}
    <div id="notifications" class="content">
        <div class="content-header notifications-header clearfix">
            <div class="container">
                <div class="col-sm-6 col-sm-offset-3">
                    <h3>Account Settings</h3>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="col-sm-6 col-sm-offset-3" role="main">
                {% crispy form %}
                <hr>
                <a href="{% url 'me:cancel' %}" data-toggle="modal" data-target="#cancel-account">Cancel my account</a>
            </div>
        </div>

        <div class="container">
            <div class="col-sm-6 col-sm-offset-3" role="main">
                <h3>Integrations</h3>
                {% if 'box' in user.profile.integrations %}
                    <a class="social-disconnect" href="{% url 'social:disconnect' backend='box' %}">Disconnect Box</a>
                {% else %}
                    <a href="{% url 'social:begin' backend='box' %}">Connect with Box</a>
                {% endif %}
                
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
    {{ block.super }}
    <div class="modal" id="change-password"></div>
    <div class="modal" id="cancel-account"></div>

    <div class="modal" id="disable-two-factor"></div>
    <div class="modal" id="enable-two-factor"></div>
    <div class="modal" id="verify-two-factor"></div>
{% endblock %}

{% block css %}
    {{ block.super }}
    {{ form.media.css }}
{% endblock %}

{% block js %}
    {{ block.super }}
    {{ form.media.js }}
    <script>
    'use strict';
    $('a.social-disconnect').on("click", function() {
        var self = $(this);
        var data = $(this).data();

        $.ajax({
          "type": 'POST',
          "url": self.attr('href'),
          "data": {},
          "dataType": 'json',
          "contentType": 'application/json',
          "beforeSend": function (jqXHR, settings) {
              // Pull the token out of the DOM.
              jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]:first').val());
          },
          "complete": function ( data ) {
              document.location.reload();
          }
        });

        return false; //this is critical to stop the click event which will trigger a normal file download!
    });
    </script>
{% endblock %}
