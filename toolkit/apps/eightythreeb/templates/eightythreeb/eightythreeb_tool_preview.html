{% extends 'dash/dash.html' %}{% load url from future %}{% load humanize crispy_forms_tags django_bootstrap_breadcrumbs %}

{% block page_title %}Preview {{ workspace }} {{ tool }}{% endblock  %}

{% block breadcrumbs %}
    {{ block.super }}
    {% breadcrumb workspace.name 'workspace:view' workspace.slug %}
    {% breadcrumb tool.name 'workspace:tool_object_list' workspace.slug tool.slug %}
    {% breadcrumb object 'workspace:tool_object_edit' workspace.slug tool.slug object.slug %}
    {% breadcrumb 'Review' '' %}
{% endblock %}


{% block content %}
<style>
 .success { background-color: #dff0d8; }
 .next {
    color: #ffffff;
    background-color: #ed9c28;
    border-color: #d58512;
    }
 #page_tabs li a {font-size:20px;}
 .tab-content {
    padding:0px 60px 0px 60px;
    border:none;
 }
 #page_tabs {
    padding-left:40px;
 }
</style>
{% csrf_token %}

<div id="pdf_review_controls" class="row">
    <div class="col-sm-12">
        <div class="row">
            <div class="col-sm-7">
                <h4>83(b) Election Letter Status</h4>
            </div>
            <div class="col-sm-5">
    <!--         Next Stage: {{ object.current_status }}<br/>
     -->        <div class="text-right">
                <small class="text-muted text-right">{{ object.markers.percent_complete }}% Complete</small></h3>
            </div>
            <div class="progress">
              <div class="progress-bar" role="progressbar" aria-valuenow="{{ object.markers.percent_complete }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ object.markers.percent_complete }}%;">
                <span class="sr-only">{{ object.markers.percent_complete }}% Complete</span>
              </div>
            </div>
            </div>
        </div>
        <div class="">
            {% if user.profile.is_lawyer %}
                {% if object.STATUS_83b.lawyer_invite_customer == object.status %}
                    <div class="dialog dialog-warning">
                        <button type="button" id="id_customer_download_pdf" class="btn btn-success redirect"
                            data-url="{% url 'workspace:tool_object_invite' workspace=workspace.slug tool=tool.slug slug=object.slug %}">Invite {{ object.user.get_full_name|default:object.user.username }} to complete the 83b</button>
                    </div>
                {% endif %}
            {% endif %}

            {% if user.profile.is_customer %}
                <div class="dialog dialog-warning">
                    {% if object.STATUS_83b.customer_complete_form == object.status %}
                        <button type="button" id="id_customer_download_pdf" class="btn btn-success redirect"
                        data-url="{% url 'workspace:tool_object_edit' workspace=workspace.slug tool=tool.slug slug=object.slug %}">Complete 83(b) Election Letter</button>
                    {% endif %}

                    {% if object.STATUS_83b.customer_download_pdf == object.status %}
                        <button type="button" id="id_customer_download_pdf" class="btn btn-success redirect"
                        data-url="{% url 'workspace:tool_object_download' workspace=workspace.slug tool=tool.slug slug=object.slug %}">Download 83(b) Election Letter with Instructions</button>
                    {% endif %}

                    {% if object.STATUS_83b.customer_print_and_sign == object.status %}
                        <button type="button" class="btn btn-success action"
                            data-method="PATCH"
                            data-url="/api/83b/{{ object.pk }}/"
                            data-tool="{{ tool.pk }}"
                            data-tool_object_id="{{ object.pk }}"
                            data-status="{{ object.STATUS_83b.customer_print_and_sign }}">I have printed and signed 2 copies of the 83b document</button>
                    {% endif %}

                    {% if object.STATUS_83b.mail_to_irs_tracking_code == object.status %}
                        <button type="button" class="btn btn-success redirect"
                            data-url="{% url 'eightythreeb:tracking_code' slug=object.slug %}">I have mailed the documents and have the tracking code to enter</button>
                    {% endif %}

                    {% if object.STATUS_83b.datestamped_copy_recieved == object.status %}
                        <button type="button" class="btn btn-success action"
                            data-method="PATCH"
                            data-url="/api/83b/{{ object.pk }}/"
                            data-tool="{{ tool.pk }}"
                            data-tool_object_id="{{ object.pk }}"
                            data-status="{{ object.STATUS_83b.datestamped_copy_recieved }}">I have recieved the date-stamped copy of my 83b back from the IRS</button>
                    {% endif %}

                    {% if object.STATUS_83b.copy_sent_to_lawyer == object.status %}
                        <button type="button" class="btn btn-success action"
                            data-method="PATCH"
                            data-url="/api/83b/{{ object.pk }}/"
                            data-tool="{{ tool.pk }}"
                            data-tool_object_id="{{ object.pk }}"
                            data-status="{{ object.STATUS_83b.copy_sent_to_lawyer }}">I have sent a copy of the 83b to my Attorney</button>
                    {% endif %}

                    {% if object.STATUS_83b.copy_sent_to_accountant == object.status %}
                        <button type="button" class="btn btn-success action"
                            data-method="PATCH"
                            data-url="/api/83b/{{ object.pk }}/"
                            data-tool="{{ tool.pk }}"
                            data-tool_object_id="{{ object.pk }}"
                            data-status="{{ object.STATUS_83b.copy_sent_to_accountant }}">I have sent a copy of the 83b to my Accountant</button>
                    {% endif %}
                </div>
            {% endif %}

            {% if object.STATUS_83b.irs_recieved == object.status %}
            <div class="row">
                <p>This is an automated part of the process, and if you have sent your documents via registered post and registered the tracking code with us; then you should simply wait for this to update.</p>
                <button type="button" class="btn btn-success redirect"
                    data-url="{% url 'eightythreeb:tracking_code' slug=object.slug %}">Update tracking code</button>

                {% if user.is_staff or user.is_superuser %}
                    <button type="button" class="btn btn-danger action"
                        data-method="PATCH"
                        data-url="/api/83b/{{ object.pk }}/"
                        data-tool="{{ tool.pk }}"
                        data-tool_object_id="{{ object.pk }}"
                        data-status="{{ object.STATUS_83b.irs_recieved }}">Staff: Skip this step</button>
                {% endif %}
            </div>
            {% endif %}

        </div>
        
    </div>
</div>

<ul id="page_tabs" class="nav nav-tabs">
  <li><a href="#checklist" data-toggle="tab">Progress</a></li>
  <li><a href="#document">83b Election Preview</a></li>
</ul>

<div class="tab-content">
    <div class="tab-pane active" id="checklist">

        <ul class="list-group">
        {% for m in object.markers %}

            <li class="list-group-item row {% if m.is_complete %}success{% else %}{% if m.previous.is_complete and not m.next.is_complete %}next{% else %}pending{% endif %}{% endif %}">
                <div class="row">
                    <div class="col-md-9">
                        {% if m.is_complete %}
                            <span class="text-success glyphicon glyphicon-check"></span> 
                            <span class="text-success">{{ m.description }}</span>
                        {% else %}
                            {{ m.description }}
                        {% endif %}

                        {% if m.date_completed %}
                            <small class="">Completed: {{ m.date_completed|naturaltime }}</small>
                        {% endif %}
                        {% if m.long_description %}
                            <br />
                            <small>{{ m.long_description }}</small>                    
                        {% endif %}
                    </div>
                    <div class="col-md-3 text-right">
                        {% if m.action_url and user.profile.user_class in m.action_user_class %}
                        <a class="btn btn-info btn-block" href="{{ m.action_url }}">{{ m.action_name }}</a>
                        {% endif %}
                    </div>
                </div>
            </li>
        {% endfor %}
        </ul>
    </div>

    <div class="tab-pane" id="document">
        {% if object.STATUS_83b.customer_download_pdf < object.status %}
            <button type="button" id="download_pdf" class="btn btn-success redirect pull-right"
            data-url="{% url 'workspace:tool_object_download' workspace=workspace.slug tool=tool.slug slug=object.slug %}">Download PDF</button>
        {% endif %}
        <br/><br/>
        <iframe name="id_preview" id="id_pdf_preview" class="fade" src="{% url 'workspace:tool_object_display' workspace=workspace.slug tool=tool.slug slug=object.slug %}"></iframe>
    </div>

</div>

{% endblock  %}

{% block css %}
<style>
iframe#id_pdf_preview {
    width:100%;
}
</style>
{% endblock  %}

{% block js %}
<script>
$(document).ready(function () {
    'use strict';

    $('ul#page_tabs a:first').tab('show')

    var iframe = $('#id_pdf_preview');
    var controls = $('#pdf_review_controls');
    iframe.height( ($('body').height() / 1.1) - controls.height() );
    iframe.removeClass('fade');

    /**
    * Redirect buttons
    */
    $('button.redirect').on( 'click', function ( e ) {
        e.preventDefault();
        var btn = $(this);

        var data = btn.data();
        var url = data['url']; delete data['url'];
        document.location = url;
    });
    /**
    * Action buttons
    */

    $('button.action').on( 'click', function ( e ) {
        e.preventDefault();
        var btn = $(this);

        var data = btn.data();
        var url = data['url']; delete data['url'];
        var method = data['method']; delete data['method'];
        //var response_success_msg = data['response_success_msg']; delete data['response_success_msg'];

        $.ajax({
            "type": method,
            "url": url,
            "data": JSON.stringify(data),
            "dataType": 'json',
            "contentType": 'application/json',
            "beforeSend": function (jqXHR, settings) {
                // Pull the token out of the DOM.
                jqXHR.setRequestHeader('X-CSRFToken', $('input[name=csrfmiddlewaretoken]:first').val());
            },
            "complete": function ( data ) {
                // reload the page to show updated lawyer info
                //btn.hide().parent().append(response_success_msg);
                document.location.reload();
            }
        });
    });

});
</script>
{% endblock  %}